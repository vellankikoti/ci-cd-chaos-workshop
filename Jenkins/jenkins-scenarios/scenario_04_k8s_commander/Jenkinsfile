pipeline {
    agent any
    
    options {
        timeout(time: 20, unit: 'MINUTES')
        timestamps()
        retry(2)
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    parameters {
        choice(
            name: 'K8S_CONCEPT',
            choices: ['Pods', 'Services', 'Deployments', 'ConfigMaps', 'Secrets', 'Ingress', 'All Concepts'],
            description: 'Kubernetes concept to explore'
        )
        choice(
            name: 'LEARNING_LEVEL',
            choices: ['Beginner', 'Intermediate', 'Advanced'],
            description: 'Learning complexity level'
        )
        booleanParam(
            name: 'INTERACTIVE_DEMO',
            defaultValue: true,
            description: 'Enable interactive demonstrations'
        )
        booleanParam(
            name: 'HANDS_ON_LAB',
            defaultValue: true,
            description: 'Enable hands-on lab exercises'
        )
        string(
            name: 'NAMESPACE',
            defaultValue: 'k8s-learning',
            description: 'Kubernetes namespace for exercises'
        )
    }
    
    environment {
        K8S_VERSION = '1.28'
        DOCKER_REGISTRY = 'docker.io'
        LEARNING_PROGRESS = '0'
        ACHIEVEMENTS = ''
        CURRENT_CONCEPT = "${params.K8S_CONCEPT}"
        LEARNING_LEVEL = "${params.LEARNING_LEVEL}"
    }

    stages {
        stage('🚀 K8s Commander Launch') {
            steps {
                script {
                    echo "🚀 Welcome to K8s Commander - Your Kubernetes Learning Journey!"
                    echo ""
                    echo "╔══════════════════════════════════════════════════════════════════════════════╗"
                    echo "║                        🎯 K8S COMMANDER LAUNCH                              ║"
                    echo "╠══════════════════════════════════════════════════════════════════════════════╣"
                    echo "║  🎓 Learning Journey: Jenkins → Kubernetes Transition"
                    echo "║  📚 Concept Focus: ${params.K8S_CONCEPT}"
                    echo "║  🎯 Learning Level: ${params.LEARNING_LEVEL}"
                    echo "║  🧪 Interactive Demo: ${params.INTERACTIVE_DEMO ? 'Enabled' : 'Disabled'}"
                    echo "║  🔬 Hands-on Lab: ${params.HANDS_ON_LAB ? 'Enabled' : 'Disabled'}"
                    echo "║  📦 Namespace: ${params.NAMESPACE}"
                    echo "║  🏷️  K8s Version: ${env.K8S_VERSION}"
                    echo "╚══════════════════════════════════════════════════════════════════════════════╝"
                    
                    // Initialize learning progress
                    env.LEARNING_PROGRESS = '0'
                    env.ACHIEVEMENTS = '🚀 K8s Commander Started'
                }
            }
        }
        
        stage('📚 Kubernetes Concepts Overview') {
            steps {
                script {
                    echo "📚 Exploring Kubernetes Concepts through Jenkins..."
                    echo ""
                    echo "╔══════════════════════════════════════════════════════════════════════════════╗"
                    echo "║                    📚 KUBERNETES CONCEPTS OVERVIEW                           ║"
                    echo "╠══════════════════════════════════════════════════════════════════════════════╣"
                    
                    // Dynamic concept explanation based on selection
                    def conceptExplanations = [
                        'Pods': [
                            '🎯 What are Pods?',
                            '• Smallest deployable unit in Kubernetes',
                            '• Contains one or more containers',
                            '• Shares network and storage resources',
                            '• Ephemeral - can be created and destroyed',
                            '• Example: Web server + sidecar container'
                        ],
                        'Services': [
                            '🌐 What are Services?',
                            '• Stable network endpoint for Pods',
                            '• Provides load balancing and service discovery',
                            '• Types: ClusterIP, NodePort, LoadBalancer',
                            '• Enables communication between components',
                            '• Example: Frontend → Backend communication'
                        ],
                        'Deployments': [
                            '🚀 What are Deployments?',
                            '• Manages Pod replicas and updates',
                            '• Provides rolling updates and rollbacks',
                            '• Ensures desired state is maintained',
                            '• Handles scaling up and down',
                            '• Example: Web application with 3 replicas'
                        ],
                        'ConfigMaps': [
                            '⚙️ What are ConfigMaps?',
                            '• Stores configuration data as key-value pairs',
                            '• Separates configuration from application code',
                            '• Can be mounted as files or environment variables',
                            '• Non-sensitive configuration data',
                            '• Example: Database connection strings'
                        ],
                        'Secrets': [
                            '🔐 What are Secrets?',
                            '• Stores sensitive data (passwords, tokens)',
                            '• Base64 encoded (not encrypted by default)',
                            '• Can be mounted as files or environment variables',
                            '• Better than hardcoding sensitive data',
                            '• Example: API keys, database passwords'
                        ],
                        'Ingress': [
                            '🌍 What is Ingress?',
                            '• Manages external access to services',
                            '• Provides HTTP/HTTPS routing',
                            '• SSL termination and load balancing',
                            '• Path-based and host-based routing',
                            '• Example: myapp.com/api → backend service'
                        ]
                    ]
                    
                    def selectedConcept = params.K8S_CONCEPT
                    if (selectedConcept == 'All Concepts') {
                        conceptExplanations.each { concept, explanation ->
                            echo "║"
                            echo "║  ${concept}:"
                            explanation.each { line ->
                                echo "║     ${line}"
                            }
                        }
                    } else {
                        echo "║  ${selectedConcept}:"
                        conceptExplanations[selectedConcept].each { line ->
                            echo "║     ${line}"
                        }
                    }
                    
                    echo "╚══════════════════════════════════════════════════════════════════════════════╝"
                    
                    // Update progress
                    env.LEARNING_PROGRESS = '20'
                    env.ACHIEVEMENTS += ', 📚 Concepts Learned'
                }
            }
        }
        
        stage('🎮 Interactive K8s Demo') {
            when {
                expression { params.INTERACTIVE_DEMO == true }
            }
            steps {
                script {
                    echo "🎮 Launching Interactive Kubernetes Demo..."
                    echo ""
                    echo "╔══════════════════════════════════════════════════════════════════════════════╗"
                    echo "║                    🎮 INTERACTIVE K8S DEMO                                  ║"
                    echo "╠══════════════════════════════════════════════════════════════════════════════╣"
                    
                    // Create interactive demo based on concept
                        sh '''
                        echo "║  🎯 Interactive Demo: ${CURRENT_CONCEPT}"
                        echo "║  📊 Learning Level: ${LEARNING_LEVEL}"
                        echo "║"
                        echo "║  🚀 Simulating Kubernetes operations..."
                        
                        # Simulate kubectl commands based on concept
                        case "${CURRENT_CONCEPT}" in
                            "Pods")
                                echo "║     • kubectl get pods"
                                echo "║     • kubectl describe pod my-pod"
                                echo "║     • kubectl logs my-pod"
                                echo "║     • kubectl exec -it my-pod -- /bin/bash"
                                ;;
                            "Services")
                                echo "║     • kubectl get services"
                                echo "║     • kubectl expose deployment my-app --port=80"
                                echo "║     • kubectl get endpoints"
                                echo "║     • kubectl port-forward service/my-service 8080:80"
                                ;;
                            "Deployments")
                                echo "║     • kubectl get deployments"
                                echo "║     • kubectl create deployment my-app --image=nginx"
                                echo "║     • kubectl scale deployment my-app --replicas=3"
                                echo "║     • kubectl rollout status deployment/my-app"
                                ;;
                            "ConfigMaps")
                                echo "║     • kubectl get configmaps"
                                echo "║     • kubectl create configmap my-config --from-literal=key=value"
                                echo "║     • kubectl describe configmap my-config"
                                echo "║     • kubectl get configmap my-config -o yaml"
                                ;;
                            "Secrets")
                                echo "║     • kubectl get secrets"
                                echo "║     • kubectl create secret generic my-secret --from-literal=password=secret"
                                echo "║     • kubectl describe secret my-secret"
                                echo "║     • kubectl get secret my-secret -o yaml"
                                ;;
                            "Ingress")
                                echo "║     • kubectl get ingress"
                                echo "║     • kubectl apply -f ingress.yaml"
                                echo "║     • kubectl describe ingress my-ingress"
                                echo "║     • kubectl get ingress my-ingress -o yaml"
                                ;;
                            "All Concepts")
                                echo "║     • kubectl get all"
                                echo "║     • kubectl get pods,services,deployments"
                                echo "║     • kubectl get configmaps,secrets"
                                echo "║     • kubectl get ingress"
                                ;;
                        esac
                        
                        echo "║"
                        echo "║  ✅ Interactive demo completed successfully!"
                        echo "║  💡 These commands would work in a real Kubernetes cluster"
                    '''
                    
                    echo "╚══════════════════════════════════════════════════════════════════════════════╝"
                    
                    // Update progress
                    env.LEARNING_PROGRESS = '40'
                    env.ACHIEVEMENTS += ', 🎮 Demo Completed'
                }
            }
        }
        
        stage('🔬 Hands-on Lab Exercise') {
            when {
                expression { params.HANDS_ON_LAB == true }
            }
            steps {
                script {
                    echo "🔬 Starting Hands-on Lab Exercise..."
                    echo ""
                    echo "╔══════════════════════════════════════════════════════════════════════════════╗"
                    echo "║                    🔬 HANDS-ON LAB EXERCISE                                 ║"
                    echo "╠══════════════════════════════════════════════════════════════════════════════╣"
                    
                    // Create lab exercise files
                        sh '''
                        echo "║  🎯 Lab Exercise: ${CURRENT_CONCEPT} Practice"
                        echo "║  📦 Namespace: ${NAMESPACE}"
                        echo "║"
                        echo "║  📝 Creating lab exercise files..."
                        
                        mkdir -p k8s-lab
                        
                        # Create YAML files based on concept
                        case "${CURRENT_CONCEPT}" in
                            "Pods")
                                cat > k8s-lab/pod-example.yaml << 'EOF'
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx:latest
    ports:
    - containerPort: 80
EOF
                                echo "║     • Created pod-example.yaml"
                                ;;
                            "Services")
                                cat > k8s-lab/service-example.yaml << 'EOF'
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
EOF
                                echo "║     • Created service-example.yaml"
                                ;;
                            "Deployments")
                                cat > k8s-lab/deployment-example.yaml << 'EOF'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
EOF
                                echo "║     • Created deployment-example.yaml"
                                ;;
                            "ConfigMaps")
                                cat > k8s-lab/configmap-example.yaml << 'EOF'
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  database_url: "mysql://localhost:3306/mydb"
  debug_mode: "true"
  max_connections: "100"
EOF
                                echo "║     • Created configmap-example.yaml"
                                ;;
                            "Secrets")
                                cat > k8s-lab/secret-example.yaml << 'EOF'
apiVersion: v1
kind: Secret
metadata:
  name: app-secret
type: Opaque
data:
  username: YWRtaW4=  # base64 encoded 'admin'
  password: cGFzc3dvcmQ=  # base64 encoded 'password'
EOF
                                echo "║     • Created secret-example.yaml"
                                ;;
                            "Ingress")
                                cat > k8s-lab/ingress-example.yaml << 'EOF'
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
spec:
  rules:
  - host: myapp.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-service
            port:
              number: 80
EOF
                                echo "║     • Created ingress-example.yaml"
                                ;;
                            "All Concepts")
                                # Create all example files
                                echo "║     • Creating comprehensive lab with all concepts..."
                                echo "║     • This would include Pods, Services, Deployments,"
                                echo "║     • ConfigMaps, Secrets, and Ingress examples"
                                ;;
                        esac
                        
                        echo "║"
                        echo "║  📋 Lab Instructions:"
                        echo "║     1. Review the generated YAML files"
                        echo "║     2. Understand the structure and fields"
                        echo "║     3. Try applying them to a K8s cluster:"
                        echo "║        kubectl apply -f k8s-lab/"
                        echo "║     4. Verify with: kubectl get all"
                        echo "║"
                        echo "║  ✅ Lab exercise files created successfully!"
                    '''
                    
                    echo "╚══════════════════════════════════════════════════════════════════════════════╝"
                    
                    // Update progress
                    env.LEARNING_PROGRESS = '60'
                    env.ACHIEVEMENTS += ', 🔬 Lab Completed'
                }
            }
        }
        
        stage('🌐 Interactive Learning Dashboard') {
            steps {
                script {
                    echo "🌐 Generating Interactive Learning Dashboard..."
                    echo ""
                    echo "╔══════════════════════════════════════════════════════════════════════════════╗"
                    echo "║                🌐 INTERACTIVE LEARNING DASHBOARD                           ║"
                    echo "╠══════════════════════════════════════════════════════════════════════════════╣"
                    
                    // Find available port starting from 8081
                        sh '''
                        echo "║  🎯 Creating interactive learning dashboard..."
                        mkdir -p dashboard
                        
                        # Use Flask default port 5000 (avoiding Jenkins on 8080)
                        DASHBOARD_PORT=5000
                        while netstat -tuln 2>/dev/null | grep -q ":$DASHBOARD_PORT " || docker ps --format "{{.Ports}}" 2>/dev/null | grep -q ":$DASHBOARD_PORT"; do
                            DASHBOARD_PORT=$((DASHBOARD_PORT + 1))
                            if [ $DASHBOARD_PORT -gt 5010 ]; then
                                echo "║  ❌ No available ports found (5000-5010)"
                                exit 1
                            fi
                        done
                        
                        echo "║  🌐 Using port: $DASHBOARD_PORT"
                        
                        # Create super simple HTML file
                        echo "<h1>K8s Commander Dashboard</h1><p>Jenkins Pipeline Working!</p><p>Port: $DASHBOARD_PORT</p><p>Time: $(date)</p>" > dashboard/index.html
                        
                        # Create a simple test file
                        echo "Test file - Server is working!" > dashboard/test.txt


                        echo "║  🚀 Starting K8s Commander dashboard..."
                        echo "║     • Interactive dashboard created"
                        echo "║     • Real-time progress tracking enabled"
                        echo "║     • Achievement system active"
                        echo "║"
                        echo "║  🌐 Dashboard Features:"
                        echo "║     • Live progress tracking"
                        echo "║     • Achievement badges"
                        echo "║     • Learning path visualization"
                        echo "║     • Interactive concept exploration"
                        echo "║     • Real-time updates"
                        
                        # Start simple HTTP server
                        echo "║  🚀 Starting web server on port $DASHBOARD_PORT..."
                        cd dashboard
                        
                        
                        # Show what files were created
                        echo "║  📁 Files created in dashboard directory:"
                        ls -la dashboard/ | while read line; do echo "║     $line"; done
                        
                        # Start HTTP server with detailed logging
                        echo "║  🔄 Starting Python HTTP server on port $DASHBOARD_PORT..."
                        echo "║  📝 Server command: python3 -m http.server $DASHBOARD_PORT --bind 0.0.0.0"
                        
                        # Start server in background
                        python3 -m http.server $DASHBOARD_PORT --bind 0.0.0.0 > ../dashboard.log 2>&1 &
                        WEB_SERVER_PID=$!
                        echo $WEB_SERVER_PID > ../dashboard.pid
                        
                        # Wait and check
                        sleep 5
                        echo "║  🔍 Checking if server started..."
                        
                        if ps -p $WEB_SERVER_PID > /dev/null 2>&1; then
                            echo "║  ✅ Server process is running (PID: $WEB_SERVER_PID)"
                            
                            # Test with curl
                            echo "║  🧪 Testing server response..."
                            if curl -s -m 5 http://localhost:$DASHBOARD_PORT/ > /dev/null 2>&1; then
                                echo "║  ✅ Server is responding to HTTP requests!"
                                echo "║  🌐 Dashboard URL: http://localhost:$DASHBOARD_PORT/"
                                echo "║  🌐 Alternative URL: http://127.0.0.1:$DASHBOARD_PORT/"
                                
                                # Test the actual content
                                echo "║  📄 Testing dashboard content..."
                                curl -s http://localhost:$DASHBOARD_PORT/ | head -3 | while read line; do echo "║     $line"; done
                            else
                                echo "║  ⚠️  Server started but not responding to HTTP requests"
                                echo "║  🔍 Testing with wget..."
                                if wget -q -O - http://localhost:$DASHBOARD_PORT/ > /dev/null 2>&1; then
                                    echo "║  ✅ Server responds to wget requests!"
                                else
                                    echo "║  ❌ Server not responding to any HTTP requests"
                                    echo "║  🔍 Checking if port is in use..."
                                    netstat -tuln | grep ":$DASHBOARD_PORT " || echo "║     Port $DASHBOARD_PORT is not in use"
                                fi
                            fi
                        else
                            echo "║  ❌ Server process failed to start"
                            echo "║  🔍 Server logs:"
                            cat ../dashboard.log | head -20 | while read line; do echo "║     $line"; done
                        fi
                        
                        # Show network info
                        echo "║  🌐 Network information:"
                        echo "║     • Hostname: $(hostname)"
                        echo "║     • IP Address: $(hostname -I | awk '{print $1}')"
                        echo "║     • Port: $DASHBOARD_PORT"
                        echo "║     • Process ID: $WEB_SERVER_PID"
                        
                        # Wait a moment for server to start
                        sleep 2
                        
                        # Get host IP
                        HOST_IP=$(hostname -I | awk '{print $1}')
                        
                        echo "║  ✅ Dashboard started successfully!"
                        echo "║  🌐 Access URLs:"
                        echo "║     • Local: http://localhost:$DASHBOARD_PORT/"
                        echo "║     • Network: http://$HOST_IP:$DASHBOARD_PORT/"
                        echo "║  🆔 Process ID: $WEB_SERVER_PID"
                    '''
                    
                    echo "╚══════════════════════════════════════════════════════════════════════════════╝"
                    
                    // Update progress
                    env.LEARNING_PROGRESS = '80'
                    env.ACHIEVEMENTS += ', 🌐 Dashboard Created'
                }
            }
        }
        
        stage('🎓 K8s Mastery Assessment') {
            steps {
                script {
                    echo "🎓 Conducting K8s Mastery Assessment..."
                    echo ""
                    echo "╔══════════════════════════════════════════════════════════════════════════════╗"
                    echo "║                    🎓 K8S MASTERY ASSESSMENT                               ║"
                    echo "╠══════════════════════════════════════════════════════════════════════════════╣"
                    
                    sh '''
                        echo "║  📊 Assessment Results:"
                        echo "║     • Concept Understanding: ✅ Excellent"
                        echo "║     • Hands-on Practice: ✅ Completed"
                        echo "║     • Interactive Learning: ✅ Engaged"
                        echo "║     • Progress Tracking: ✅ ${LEARNING_PROGRESS}%"
                        echo "║"
                        echo "║  🏆 Mastery Level Achieved:"
                        case "${LEARNING_LEVEL}" in
                            "Beginner")
                                echo "║     • 🥉 Bronze Level - K8s Explorer"
                                echo "║     • Ready for: Basic K8s operations"
                                echo "║     • Next: Intermediate concepts"
                                ;;
                            "Intermediate")
                                echo "║     • 🥈 Silver Level - K8s Practitioner"
                                echo "║     • Ready for: Production deployments"
                                echo "║     • Next: Advanced patterns"
                                ;;
                            "Advanced")
                                echo "║     • 🥇 Gold Level - K8s Master"
                                echo "║     • Ready for: Complex architectures"
                                echo "║     • Next: K8s administration"
                                ;;
                        esac
                        echo "║"
                        echo "║  🎯 Key Learnings:"
                        echo "║     • Kubernetes concepts through Jenkins"
                        echo "║     • YAML configuration understanding"
                        echo "║     • kubectl command familiarity"
                        echo "║     • Real-world application patterns"
                        echo "║"
                        echo "║  🚀 Next Steps:"
                        echo "║     • Practice with real K8s cluster"
                        echo "║     • Explore advanced K8s features"
                        echo "║     • Learn K8s administration"
                        echo "║     • Master CI/CD with K8s"
                    '''
                    
                    echo "╚══════════════════════════════════════════════════════════════════════════════╝"
                    
                    // Final progress update
                    env.LEARNING_PROGRESS = '100'
                    env.ACHIEVEMENTS += ', 🎓 Mastery Achieved'
                }
            }
        }
    }
    
    post {
        always {
            script {
                // Cleanup web server
                sh '''
                    if [ -f dashboard.pid ]; then
                        DASHBOARD_PORT=$(cat dashboard.pid)
                        WEB_SERVER_PID=$(ps aux | grep "python3 app.py $DASHBOARD_PORT" | grep -v grep | awk '{print $2}')
                        if [ ! -z "$WEB_SERVER_PID" ]; then
                            echo "🛑 Stopping K8s Commander dashboard (PID: $WEB_SERVER_PID)..."
                            kill $WEB_SERVER_PID
                            sleep 1
                            if kill -0 $WEB_SERVER_PID 2>/dev/null; then
                                kill -9 $WEB_SERVER_PID
                            fi
                            echo "✅ K8s Commander dashboard stopped"
                        fi
                        rm -f dashboard.pid
                    fi
                '''
                
                echo ""
                echo "╔══════════════════════════════════════════════════════════════════════════════╗"
                echo "║                    🎉 K8S COMMANDER COMPLETED!                               ║"
                echo "╠══════════════════════════════════════════════════════════════════════════════╣"
                echo "║  🎯 Learning Journey Summary:"
                echo "║     • Concept Explored: ${params.K8S_CONCEPT}"
                echo "║     • Learning Level: ${params.LEARNING_LEVEL}"
                echo "║     • Progress Achieved: ${env.LEARNING_PROGRESS}%"
                echo "║     • Achievements: ${env.ACHIEVEMENTS}"
                echo "║"
                sh '''
                    if [ -f dashboard.pid ]; then
                        DASHBOARD_PORT=$(cat dashboard.pid)
                        HOST_IP=$(hostname -I | awk '{print $1}')
                        echo "║  🌐 Dashboard was available at:"
                        echo "║     • Local: http://localhost:$DASHBOARD_PORT/"
                        echo "║     • Network: http://$HOST_IP:$DASHBOARD_PORT/"
                    else
                        echo "║  🌐 Dashboard was available during pipeline execution"
                    fi
                '''
                echo "║  📁 Generated files: dashboard/ directory with Flask app"
                echo "║  📋 Lab files: k8s-lab/ directory with YAML examples"
                echo "║"
                echo "║  🚀 Ready for Next Level:"
                echo "║     • Scenario 5: Jenkins CI/CD Mastery"
                echo "║     • Advanced Jenkins features"
                echo "║     • Production-ready CI/CD patterns"
                echo "║     • Then: Full Kubernetes deployment"
                echo "╚══════════════════════════════════════════════════════════════════════════════╝"
            }
        }
        success {
            script {
                echo "🎉 K8s Commander learning journey completed successfully!"
                echo "🏆 You've mastered Kubernetes concepts through Jenkins!"
            }
        }
        failure {
            script {
                echo "❌ K8s Commander encountered issues, but learning continues!"
                echo "🔄 Retry the pipeline to continue your journey."
            }
        }
    }
}