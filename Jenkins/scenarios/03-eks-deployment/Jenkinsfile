pipeline {
    agent {
        docker {
            image 'python:3.9-slim'
            args '-u root -v /var/run/docker.sock:/var/run/docker.sock'
        }
    }
    
    parameters {
        string(
            name: 'CLUSTER_NAME',
            defaultValue: 'eks-demo-cluster',
            description: 'Name of the EKS cluster to create'
        )
        choice(
            name: 'NODE_INSTANCE_TYPE',
            choices: ['t3.small', 't3.medium', 't3.large'],
            description: 'EC2 instance type for worker nodes (t3.small for cost optimization)'
        )
        string(
            name: 'AWS_REGION',
            defaultValue: 'us-east-1',
            description: 'AWS region for EKS cluster deployment'
        )
        string(
            name: 'NODE_COUNT',
            defaultValue: '3',
            description: 'Number of worker nodes (default: 3)'
        )
        booleanParam(
            name: 'ENABLE_LOGGING',
            defaultValue: true,
            description: 'Enable EKS control plane logging'
        )
        booleanParam(
            name: 'ENABLE_ALB_CONTROLLER',
            defaultValue: true,
            description: 'Install AWS Load Balancer Controller'
        )
        credentials(
            name: 'AWS_CREDENTIALS',
            credentialType: 'com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl',
            defaultValue: '',
            description: 'AWS Access Key ID and Secret Access Key (Username=Access Key, Password=Secret Key) - REQUIRED'
        )
    }
    
    environment {
        STACK_NAME = "${params.CLUSTER_NAME}-${BUILD_NUMBER}"
        AWS_REGION = "${params.AWS_REGION}"
        CLUSTER_NAME = "${params.CLUSTER_NAME}-${BUILD_NUMBER}"
        AWS_DEFAULT_REGION = "${params.AWS_REGION}"
        NODE_INSTANCE_TYPE = "${params.NODE_INSTANCE_TYPE}"
        NODE_COUNT = "${params.NODE_COUNT}"
        ENABLE_LOGGING = "${params.ENABLE_LOGGING}"
        ENABLE_ALB_CONTROLLER = "${params.ENABLE_ALB_CONTROLLER}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out code for EKS Deployment'
                checkout scm
            }
        }
        
        stage('Install Prerequisites') {
            steps {
                echo 'Installing AWS CLI, kubectl, eksctl, and Helm'
                sh '''#!/bin/bash
                    set -e
                    echo "üîß Installing required tools..."
                    
                    # Update package list
                    apt-get update -y
                    
                    # Install system dependencies
                    apt-get install -y curl unzip wget gnupg lsb-release ca-certificates python3-pip
                    
                    # Detect architecture
                    ARCH=$(uname -m)
                    echo "Architecture detected: $ARCH"
                    
                    # Install AWS CLI v2
                    echo "Installing AWS CLI v2..."
                    if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
                        curl -s "https://awscli.amazonaws.com/awscli-exe-linux-aarch64.zip" -o "awscliv2.zip"
                    else
                        curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                    fi
                    unzip -q awscliv2.zip
                    ./aws/install --update
                    rm -rf awscliv2.zip aws/
                    
                    # Install kubectl
                    echo "Installing kubectl..."
                    if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
                        curl -s -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/arm64/kubectl"
                    else
                        curl -s -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                    fi
                    chmod +x kubectl
                    mv kubectl /usr/local/bin/
                    
                    # Install eksctl
                    echo "Installing eksctl..."
                    if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
                        curl -s --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_arm64.tar.gz" | tar xz -C /tmp
                    else
                        curl -s --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
                    fi
                    mv /tmp/eksctl /usr/local/bin/
                    
                    # Install Helm
                    echo "Installing Helm..."
                    curl -s https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
                    
                    # Install Python dependencies
                    echo "Installing Python dependencies..."
                    pip install --no-cache-dir -r Jenkins/scenarios/03-eks-deployment/requirements.txt
                    
                    # Verify installations
                    echo "Verifying installations..."
                    aws --version
                    kubectl version --client
                    eksctl version
                    helm version
                    
                    echo "‚úÖ All tools installed successfully"
                '''
            }
        }
        
        stage('Configure AWS Credentials') {
            steps {
                echo 'Configuring AWS credentials and environment'
                script {
                    if (!params.AWS_CREDENTIALS || params.AWS_CREDENTIALS == '') {
                        error("‚ùå AWS_CREDENTIALS parameter is required but not provided. Please select AWS credentials in the job parameters.")
                    }
                    
                    withCredentials([usernamePassword(credentialsId: "${params.AWS_CREDENTIALS}", usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                        sh '''#!/bin/bash
                            set -e
                            echo "üîß Configuring AWS credentials..."
                            
                            # Set AWS credentials
                            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
                            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                            export AWS_DEFAULT_REGION=${AWS_REGION}
                            
                            # Configure AWS CLI
                            aws configure set aws_access_key_id ${AWS_ACCESS_KEY_ID}
                            aws configure set aws_secret_access_key ${AWS_SECRET_ACCESS_KEY}
                            aws configure set default.region ${AWS_REGION}
                            
                            # Test AWS credentials
                            echo "Testing AWS credentials..."
                            aws sts get-caller-identity
                            
                            echo "‚úÖ AWS credentials configured successfully"
                            echo "   Region: ${AWS_REGION}"
                            # Use printf instead of bash substring to avoid substitution issues
                            printf "   Access Key: %.8s...\n" "${AWS_ACCESS_KEY_ID}"
                        '''
                    }
                }
            }
        }
        
        stage('Validate Prerequisites') {
            steps {
                echo 'Validating AWS CLI and kubectl installation'
                script {
                    withCredentials([usernamePassword(credentialsId: "${params.AWS_CREDENTIALS}", usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                        sh '''#!/bin/bash
                            set -e
                            # Set AWS credentials
                            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
                            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                            export AWS_DEFAULT_REGION=${AWS_REGION}
                            
                            echo "üîç Validating prerequisites..."
                            
                            # Check AWS CLI
                            aws --version
                            
                            # Check kubectl
                            kubectl version --client
                            
                            # Check eksctl
                            eksctl version
                            
                            # Check Helm
                            helm version
                            
                            # Validate AWS credentials
                            aws sts get-caller-identity
                            
                            echo "‚úÖ All prerequisites validated successfully"
                        '''
                    }
                }
            }
        }
        
        stage('Test') {
            steps {
                echo 'Running tests for EKS Deployment'
                sh '''#!/bin/bash
                    echo "Running tests..."
                    cd Jenkins/scenarios/03-eks-deployment
                    export PYTHONPATH="${PWD}:${PYTHONPATH}"
                    # Run tests but don't fail the pipeline if they fail
                    python -m pytest tests/ -v --tb=short || echo "Some tests failed, but continuing with deployment..."
                '''
            }
        }
        
        stage('Deploy EKS Cluster') {
            steps {
                echo 'Deploying EKS Cluster with cost optimization'
                script {
                    withCredentials([usernamePassword(credentialsId: "${params.AWS_CREDENTIALS}", usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                        sh '''#!/bin/bash
                            set -e
                            # Set AWS credentials
                            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
                            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                            export AWS_DEFAULT_REGION=${AWS_REGION}
                            
                            echo "üöÄ Starting EKS cluster deployment..."
                            echo "Cluster Name: ${CLUSTER_NAME}"
                            echo "Stack Name: ${STACK_NAME}"
                            echo "Region: ${AWS_REGION}"
                            echo "Node Instance Type: ${NODE_INSTANCE_TYPE}"
                            echo "Node Count: ${NODE_COUNT}"
                            
                            # Create cost-optimized CloudFormation stack
                            cd Jenkins/scenarios/03-eks-deployment
                            export PYTHONPATH="${PWD}:${PYTHONPATH}"
                            
                            # Convert boolean parameters to proper format
                            ENABLE_LOGGING_FLAG=""
                            ENABLE_ALB_FLAG=""
                            
                            if [ "${ENABLE_LOGGING}" = "true" ]; then
                                ENABLE_LOGGING_FLAG="--enable-logging"
                            fi
                            
                            if [ "${ENABLE_ALB_CONTROLLER}" = "true" ]; then
                                ENABLE_ALB_FLAG="--enable-alb-controller"
                            fi
                            
                            python eks_manager.py deploy \
                                --cluster-name ${CLUSTER_NAME} \
                                --stack-name ${STACK_NAME} \
                                --region ${AWS_REGION} \
                                --node-instance-type ${NODE_INSTANCE_TYPE} \
                                --node-count ${NODE_COUNT} \
                                ${ENABLE_LOGGING_FLAG} \
                                ${ENABLE_ALB_FLAG}
                        '''
                    }
                }
            }
        }
        
        stage('Configure kubectl') {
            steps {
                echo 'Configuring kubectl and generating kubeconfig'
                script {
                    withCredentials([usernamePassword(credentialsId: "${params.AWS_CREDENTIALS}", usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                        sh '''#!/bin/bash
                            set -e
                            # Set AWS credentials
                            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
                            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                            export AWS_DEFAULT_REGION=${AWS_REGION}
                            
                            echo "üîß Configuring kubectl for cluster: ${CLUSTER_NAME}"
                            cd Jenkins/scenarios/03-eks-deployment
                            export PYTHONPATH="${PWD}:${PYTHONPATH}"
                            python eks_manager.py configure-kubectl \
                                --cluster-name ${CLUSTER_NAME} \
                                --region ${AWS_REGION}
                            
                            echo "üîç Verifying cluster connectivity..."
                            kubectl get nodes
                            kubectl get pods --all-namespaces
                        '''
                    }
                }
            }
        }
        
        stage('Post-Deployment Setup') {
            steps {
                echo 'Running post-deployment setup and add-ons installation'
                script {
                    withCredentials([usernamePassword(credentialsId: "${params.AWS_CREDENTIALS}", usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                        sh '''#!/bin/bash
                            set -e
                            # Set AWS credentials
                            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
                            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                            export AWS_DEFAULT_REGION=${AWS_REGION}
                            
                            echo "üîß Running post-deployment setup..."
                            cd Jenkins/scenarios/03-eks-deployment
                            export PYTHONPATH="${PWD}:${PYTHONPATH}"
                            python eks_manager.py post-deploy \
                                --cluster-name ${CLUSTER_NAME} \
                                --stack-name ${STACK_NAME} \
                                --region ${AWS_REGION}
                        '''
                    }
                }
            }
        }
        
        stage('Generate Connection Info') {
            steps {
                echo 'Generating connection information and commands'
                script {
                    withCredentials([usernamePassword(credentialsId: "${params.AWS_CREDENTIALS}", usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                        sh '''#!/bin/bash
                            set -e
                            # Set AWS credentials
                            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
                            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                            export AWS_DEFAULT_REGION=${AWS_REGION}
                            
                            echo "üìã Generating connection information..."
                            cd Jenkins/scenarios/03-eks-deployment
                            export PYTHONPATH="${PWD}:${PYTHONPATH}"
                            python eks_manager.py generate-connection-info \
                                --cluster-name ${CLUSTER_NAME} \
                                --region ${AWS_REGION} \
                                --output-file connection-info.txt
                            
                            echo "üìÑ Connection information saved to connection-info.txt"
                            cat connection-info.txt
                        '''
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline completed for EKS Deployment'
            script {
                // Archive connection info if it exists
                sh '''#!/bin/bash
                    ls -la Jenkins/scenarios/03-eks-deployment/connection-info.txt || echo "No connection-info.txt found"
                '''
                archiveArtifacts artifacts: 'Jenkins/scenarios/03-eks-deployment/connection-info.txt', fingerprint: true, allowEmptyArchive: true
            }
        }
        success {
            echo 'Pipeline succeeded for EKS Deployment'
            script {
                sh '''#!/bin/bash
                    echo "üéâ EKS cluster deployment completed successfully!"
                    echo "üìã Cluster Details:"
                    echo "   Cluster Name: ${CLUSTER_NAME}"
                    echo "   Region: ${AWS_REGION}"
                    echo "   Stack Name: ${STACK_NAME}"
                    echo ""
                    echo "üîó To connect to your cluster, run:"
                    echo "   aws eks update-kubeconfig --region ${AWS_REGION} --name ${CLUSTER_NAME}"
                    echo ""
                    echo "üìÑ Check connection-info.txt for detailed connection instructions"
                '''
            }
        }
        failure {
            echo 'Pipeline failed for EKS Deployment'
            script {
                sh '''#!/bin/bash
                    echo "‚ùå EKS cluster deployment failed!"
                    echo "üîç Check the logs above for error details"
                    echo "üßπ You may need to clean up resources manually:"
                    echo "   aws cloudformation delete-stack --stack-name ${STACK_NAME} --region ${AWS_REGION}"
                '''
            }
        }
        cleanup {
            echo 'Cleaning up temporary files'
            sh '''#!/bin/bash
                rm -f *.tmp *.log || true
            '''
        }
    }
}