<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root {
      --primary: #2a5d9f;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #222;
      --border: #e0e0e0;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--light);
      color: var(--dark);
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 980px;
      margin: 2em auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
      padding: 2em;
    }
    h1, h2 {
      color: var(--primary);
      margin-top: 0;
    }
    .summary {
      font-size: 1.1em;
      margin-bottom: 1.5em;
    }
    .badge {
      display: inline-block;
      padding: 0.3em 0.8em;
      border-radius: 1em;
      font-size: 0.95em;
      font-weight: 600;
      color: #fff;
      margin-right: 0.5em;
    }
    .badge-success { background: var(--success);}
    .badge-danger { background: var(--danger);}
    .badge-warning { background: var(--warning); color: #222;}
    .badge-info { background: var(--primary);}
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5em;
      font-size: 1em;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 0.7em 0.5em;
      text-align: left;
    }
    th {
      background: var(--primary);
      color: #fff;
      font-weight: 600;
    }
    tr.severity-high { background: #ffeaea; }
    tr.severity-medium { background: #fffbe6; }
    tr.severity-low { background: #eafaf1; }
    tr:hover { background: #f1f7ff; }
    code {
      background: #f4f4f4;
      color: #c7254e;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.98em;
    }
    .barchart-container {
      margin: 2em 0 1em 0;
      background: #f7fafd;
      border-radius: 8px;
      padding: 1.2em 1em;
    }
    .barchart-title {
      font-weight: 600;
      margin-bottom: 0.7em;
    }
    .bar-row {
      display: flex;
      align-items: center;
      margin-bottom: 0.5em;
    }
    .bar-label {
      min-width: 120px;
      font-size: 1em;
      color: var(--primary);
    }
    .bar {
      height: 22px;
      background: linear-gradient(90deg, var(--primary) 60%, #6bb3f2 100%);
      color: #fff;
      border-radius: 5px;
      margin-left: 10px;
      display: flex;
      align-items: center;
      font-weight: 600;
      padding-left: 10px;
      transition: width 0.5s;
    }
    .footer {
      margin-top: 2.5em;
      text-align: center;
      color: #888;
      font-size: 0.98em;
    }
    @media (max-width: 700px) {
      .container { padding: 1em 0.5em; }
      th, td { font-size: 0.95em; }
      .bar-label { min-width: 80px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>{{ title }}</h1>
    <div class="summary">
      <span class="badge badge-info" aria-label="Scan Mode">Mode: {{ mode }}</span>
      {% if secrets %}
        <span class="badge badge-danger" aria-label="Secrets Found">{{ secrets|length }} secrets found</span>
      {% else %}
        <span class="badge badge-success" aria-label="No Secrets">No secrets found</span>
      {% endif %}
      <br />
      <span>{{ summary }}</span>
    </div>

    {% if secrets %}
      <h2>Secrets Detected</h2>
      <div class="barchart-container" role="region" aria-labelledby="barchart-title">
        <div id="barchart-title" class="barchart-title">Secrets by Type</div>
        <div id="barchart"></div>
      </div>
      <table aria-label="Secrets Table">
        <thead>
          <tr>
            <th scope="col">Type</th>
            <th scope="col">File</th>
            <th scope="col">Line</th>
            <th scope="col">Masked Snippet</th>
            <th scope="col">Severity</th>
          </tr>
        </thead>
        <tbody>
          {% for secret in secrets %}
          <tr class="severity-{{ secret.severity|lower }}">
            <td>{{ secret.type }}</td>
            <td>{{ secret.file }}</td>
            <td>{{ secret.line }}</td>
            <td><code>{{ secret.snippet }}</code></td>
            <td>
              <span class="badge badge-{% if secret.severity == 'High' %}danger{% elif secret.severity == 'Medium' %}warning{% else %}success{% endif %}">
                {{ secret.severity }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <h2 style="color: var(--success); margin-top: 2em;">No secrets found! âœ…</h2>
    {% endif %}

    <div class="footer">
      <hr />
      <div>Generated by <b>CI/CD Chaos Workshop</b> &mdash; Scenario 4: Manage Secrets</div>
      <div>{{ generation_time if generation_time else "" }}</div>
    </div>
  </div>

  {% if secrets %}
  <script type="text/javascript">
    (function() {
      const data = JSON.parse('{{ bar_chart_data | tojson | safe }}');
      const container = document.getElementById('barchart');
      if (data && Object.keys(data).length > 0) {
        const max = Math.max(...Object.values(data));
        let html = '';
        for (const [type, count] of Object.entries(data)) {
          const width = Math.max(40, (count / max) * 300);
          html += `
            <div class="bar-row">
              <span class="bar-label">${type}</span>
              <div class="bar" style="width:${width}px">${count}</div>
            </div>
          `;
        }
        container.innerHTML = html;
      } else {
        container.innerHTML = "<em>No secrets detected by type.</em>";
      }
    })();
  </script>
  {% endif %}
</body>
</html>
