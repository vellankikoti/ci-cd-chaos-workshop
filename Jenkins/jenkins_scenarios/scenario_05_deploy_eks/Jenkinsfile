pipeline {
    agent any

    environment {
        AWS_DEFAULT_REGION = "us-east-1"
    }

    stages {
        stage('Prepare kubeconfig') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'aws-credentials'
                ]]) {
                    echo "ðŸ”§ Updating kubeconfig for EKS cluster..."

                    sh '''
                        aws eks update-kubeconfig --name my-cluster --region $AWS_DEFAULT_REGION
                    '''
                }
            }
        }

        stage('Validate Deployment YAML') {
            steps {
                echo "âœ… Validating Kubernetes YAML manifests..."

                sh '''
                    kubeval k8s/deployment.yaml
                '''
            }
        }

        stage('Deploy to EKS') {
            steps {
                echo "ðŸš€ Applying Kubernetes manifests..."

                sh '''
                    kubectl apply -f k8s/deployment.yaml
                    kubectl rollout status deployment my-deployment
                '''
            }
        }
    }
}
