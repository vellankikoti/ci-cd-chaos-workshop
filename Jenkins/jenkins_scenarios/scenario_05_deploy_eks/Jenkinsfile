pipeline {
    agent any

    environment {
        // Use dynamic workspace path instead of hardcoded
        SCENARIO_PATH = "${WORKSPACE}/Jenkins/jenkins_scenarios/scenario_05_deploy_eks"
        IMAGE_NAME = "chaos-workshop-eks-deployment"
        BUILD_TAG = "${BUILD_NUMBER}"
        REPORTS_DIR = 'reports'
    }

    parameters {
        booleanParam(
            name: 'RUN_KUBECTL_TESTS',
            defaultValue: true,
            description: 'ðŸ”§ Run kubectl Command Tests'
        )
        booleanParam(
            name: 'RUN_DEPLOYMENT_TESTS',
            defaultValue: true,
            description: 'ðŸš€ Run Deployment Tests'
        )
        booleanParam(
            name: 'RUN_SERVICE_TESTS',
            defaultValue: true,
            description: 'ðŸŒ Run Service Tests'
        )
        booleanParam(
            name: 'KUBECTL_PASS',
            defaultValue: true,
            description: 'âœ… kubectl Tests: Pass (true) or Fail (false)'
        )
        booleanParam(
            name: 'DEPLOYMENT_PASS',
            defaultValue: true,
            description: 'âœ… Deployment Tests: Pass (true) or Fail (false)'
        )
        booleanParam(
            name: 'VULNERABILITY_PASS',
            defaultValue: true,
            description: 'âœ… Vulnerability Scan: Pass (true) or Fail (false)'
        )
    }

    stages {
        stage('ðŸ”§ Setup Docker Permissions') {
            steps {
                sh '''
                    echo "ðŸ”§ Setting up Docker permissions..."
                    
                    # Ensure Docker socket is accessible
                    if [ ! -S /var/run/docker.sock ]; then
                        echo "ERROR: Docker socket not found at /var/run/docker.sock!"
                        echo "Make sure Docker is running and the socket is mounted in Jenkins container"
                        exit 1
                    fi
                    
                    # Check current user and Docker socket permissions
                    echo "Current user: $(whoami)"
                    echo "Docker socket permissions: $(ls -la /var/run/docker.sock)"
                    
                    # Try to fix permissions if needed (ignore errors if no sudo access)
                    sudo chmod 666 /var/run/docker.sock 2>/dev/null || echo "Note: Could not change socket permissions (no sudo access)"
                    
                    # Test Docker access
                    if docker ps > /dev/null 2>&1; then
                        echo "âœ… Docker access verified successfully"
                        docker --version
                    else
                        echo "âŒ ERROR: Cannot access Docker daemon"
                        echo "Please ensure:"
                        echo "1. Docker is running"
                        echo "2. Jenkins container has Docker socket mounted: -v /var/run/docker.sock:/var/run/docker.sock"
                        echo "3. Jenkins user has Docker permissions"
                        exit 1
                    fi
                '''
            }
        }

        stage('ðŸ“ Verify Local Workspace') {
            steps {
                sh '''
                    echo "=== WORKSPACE VERIFICATION ==="
                    echo "Current working directory: $(pwd)"
                    echo "WORKSPACE environment variable: ${WORKSPACE}"
                    echo "SCENARIO_PATH: ${SCENARIO_PATH}"
                    
                    echo "=== Workspace contents ==="
                    ls -la
                    
                    echo "=== Checking for Jenkins directory ==="
                    if [ -d "Jenkins" ]; then
                        echo "âœ… Jenkins directory found"
                        ls -la Jenkins/
                    else
                        echo "âŒ Jenkins directory not found in workspace"
                        echo "Available directories:"
                        ls -la
                        exit 1
                    fi
                    
                    echo "=== Checking scenario directory ==="
                    if [ -d "${SCENARIO_PATH}" ]; then
                        echo "âœ… Scenario directory found: ${SCENARIO_PATH}"
                        ls -la "${SCENARIO_PATH}/"
                    else
                        echo "âŒ Scenario directory not found: ${SCENARIO_PATH}"
                        echo "Checking if Jenkins scenarios exist..."
                        find . -name "scenario_05_deploy_eks" -type d
                        exit 1
                    fi

                    echo "=== Checking required files ==="
                    for file in Dockerfile requirements.txt; do
                        if [ -f "${SCENARIO_PATH}/${file}" ]; then
                            echo "âœ… ${file} found"
                        else
                            echo "âŒ ${file} not found in ${SCENARIO_PATH}"
                            echo "Contents of scenario directory:"
                            ls -la "${SCENARIO_PATH}/"
                            exit 1
                        fi
                    done
                    
                    echo "=== Checking for Kubernetes manifests ==="
                    if [ -d "${SCENARIO_PATH}/k8s" ] || [ -d "${SCENARIO_PATH}/manifests" ]; then
                        echo "âœ… Kubernetes manifests directory found"
                        ls -la "${SCENARIO_PATH}/k8s/" "${SCENARIO_PATH}/manifests/" 2>/dev/null || true
                    else
                        echo "âš ï¸ Warning: No k8s or manifests directory found"
                    fi
                    
                    echo "=== Creating reports directory ==="
                    mkdir -p "${WORKSPACE}/reports"
                    echo "âœ… Reports directory ready: ${WORKSPACE}/reports"
                    
                    echo "âœ… All workspace verification checks passed!"
                '''
            }
        }

        stage('ðŸ”§ Build Docker Image') {
            steps {
                sh """
                    echo "ðŸ› ï¸ Building Docker image: ${IMAGE_NAME}:${BUILD_TAG}"
                    echo "Current directory: \$(pwd)"
                    echo "Using Dockerfile: ${SCENARIO_PATH}/Dockerfile"
                    echo "Build context: ${SCENARIO_PATH}"
                    
                    # Verify all required files are present
                    echo "=== Verifying build context files ==="
                    ls -la "${SCENARIO_PATH}/"
                    
                    # Show Dockerfile content for debugging
                    echo "=== Dockerfile content ==="
                    cat "${SCENARIO_PATH}/Dockerfile"
                    
                    # Build the Docker image
                    docker build \\
                        -t ${IMAGE_NAME}:${BUILD_TAG} \\
                        -f "${SCENARIO_PATH}/Dockerfile" \\
                        "${SCENARIO_PATH}" || {
                        echo "âŒ Docker build failed!"
                        echo "Build context contents:"
                        ls -la "${SCENARIO_PATH}/"
                        exit 1
                    }
                    
                    echo "âœ… Docker image built successfully: ${IMAGE_NAME}:${BUILD_TAG}"
                    docker images | grep "${IMAGE_NAME}" || echo "Warning: Image not found in docker images output"
                """
            }
        }

        stage('ðŸ§¹ Pre-Cleanup') {
            steps {
                sh '''
                    echo "ðŸ”ª Pre-cleanup: Killing leftover containers..."
                    docker ps -q --filter name=chaos-workshop | xargs -r docker rm -f || true
                '''
            }
        }

        stage('ðŸš€ Run EKS Tests') {
            parallel {
                stage('ðŸ”§ kubectl Commands') {
                    when {
                        expression { params.RUN_KUBECTL_TESTS }
                    }
                    steps {
                        script {
                            def testMode = params.KUBECTL_PASS ? 'pass' : 'fail'
                            echo "Running kubectl Tests in ${testMode} mode"
                            
                            sh """
                                echo "=== kubectl Command Tests ==="
                                
                                # Run test in container with proper volume mounts
                                docker run --rm \\
                                    -v /var/run/docker.sock:/var/run/docker.sock \\
                                    -v "${WORKSPACE}/reports:/app/reports" \\
                                    -w /app \\
                                    ${IMAGE_NAME}:${BUILD_TAG} \\
                                    sh -c "
                                        echo 'Running kubectl command tests...'
                                        
                                        # Check for kubectl availability
                                        if command -v kubectl >/dev/null 2>&1; then
                                            echo 'kubectl found:'
                                            kubectl version --client || echo 'kubectl client version check failed'
                                        else
                                            echo 'kubectl not found in container'
                                        fi
                                        
                                        # Run the test if it exists
                                        if [ -f tests/test_kubectl_commands.py ]; then
                                            python tests/test_kubectl_commands.py --mode ${testMode} || echo 'kubectl test completed with mode: ${testMode}'
                                        else
                                            echo 'kubectl test file not found, creating mock result'
                                            echo '{\"status\": \"${testMode}\", \"test\": \"kubectl_commands\", \"message\": \"kubectl test simulated\"}' > reports/kubectl_${testMode}.json
                                        fi
                                    "
                            """
                        }
                    }
                }

                stage('ðŸš€ Deployment Tests') {
                    when {
                        expression { params.RUN_DEPLOYMENT_TESTS }
                    }
                    steps {
                        script {
                            def testMode = params.DEPLOYMENT_PASS ? 'pass' : 'fail'
                            echo "Running Deployment Tests in ${testMode} mode"
                            
                            sh """
                                echo "=== Deployment Tests ==="
                                
                                # Run test in container with proper volume mounts
                                docker run --rm \\
                                    -v /var/run/docker.sock:/var/run/docker.sock \\
                                    -v "${WORKSPACE}/reports:/app/reports" \\
                                    -w /app \\
                                    ${IMAGE_NAME}:${BUILD_TAG} \\
                                    sh -c "
                                        echo 'Running deployment tests...'
                                        
                                        # Check for Kubernetes manifests
                                        echo 'Looking for Kubernetes manifests...'
                                        find . -name '*.yaml' -o -name '*.yml' | grep -E '(k8s|manifest|deploy)' | head -5 || echo 'No K8s manifests found'
                                        
                                        # Run the test if it exists
                                        if [ -f tests/test_deployment.py ]; then
                                            python tests/test_deployment.py --mode ${testMode} || echo 'Deployment test completed with mode: ${testMode}'
                                        else
                                            echo 'Deployment test file not found, creating mock result'
                                            echo '{\"status\": \"${testMode}\", \"test\": \"deployment\", \"message\": \"Deployment test simulated\"}' > reports/deployment_${testMode}.json
                                        fi
                                    "
                            """
                        }
                    }
                }

                stage('ðŸŒ Service Tests') {
                    when {
                        expression { params.RUN_SERVICE_TESTS }
                    }
                    steps {
                        script {
                            def testMode = params.VULNERABILITY_PASS ? 'pass' : 'fail'
                            echo "Running Service Tests in ${testMode} mode"
                            
                            sh """
                                echo "=== Service Tests ==="
                                
                                # Run test in container with proper volume mounts
                                docker run --rm \\
                                    -v /var/run/docker.sock:/var/run/docker.sock \\
                                    -v "${WORKSPACE}/reports:/app/reports" \\
                                    -w /app \\
                                    ${IMAGE_NAME}:${BUILD_TAG} \\
                                    sh -c "
                                        echo 'Running service tests...'
                                        
                                        # Check for service manifests
                                        echo 'Looking for service manifests...'
                                        find . -name '*.yaml' -o -name '*.yml' | xargs grep -l 'kind: Service' | head -5 || echo 'No service manifests found'
                                        
                                        # Run the test if it exists
                                        if [ -f tests/test_service.py ]; then
                                            python tests/test_service.py --mode ${testMode} || echo 'Service test completed with mode: ${testMode}'
                                        else
                                            echo 'Service test file not found, creating mock result'
                                            echo '{\"status\": \"${testMode}\", \"test\": \"service\", \"message\": \"Service test simulated\"}' > reports/service_${testMode}.json
                                        fi
                                    "
                            """
                        }
                    }
                }
            }
        }

        stage('ðŸ“‹ Generate EKS Report') {
            steps {
                sh """
                    echo "ðŸ“‹ Generating EKS Report..."
                    
                    # Ensure reports directory exists
                    mkdir -p "${WORKSPACE}/reports"
                    
                    # Run report generation in container
                    docker run --rm \\
                        -v "${WORKSPACE}/reports:/app/reports" \\
                        -w /app \\
                        ${IMAGE_NAME}:${BUILD_TAG} \\
                        sh -c "
                            echo 'Generating EKS deployment report...'
                            if [ -f tests/generate_eks_report.py ]; then
                                python tests/generate_eks_report.py || echo 'Report generation completed'
                            else
                                echo 'EKS report generator not found, creating basic report'
                                cat > reports/eks_report.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>EKS Deployment Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .header { background-color: #f0f0f0; padding: 20px; }
        .result { margin: 20px 0; padding: 15px; border-left: 4px solid #007cba; }
        .pass { border-left-color: #28a745; }
        .fail { border-left-color: #dc3545; }
    </style>
</head>
<body>
    <div class='header'>
        <h1>EKS Deployment Test Report</h1>
        <p>Generated on: \$(date)</p>
    </div>
    <div class='result ${params.KUBECTL_PASS ? 'pass' : 'fail'}'>
        <h3>kubectl Commands</h3>
        <p>Status: ${params.KUBECTL_PASS ? 'PASS' : 'FAIL'}</p>
    </div>
    <div class='result ${params.DEPLOYMENT_PASS ? 'pass' : 'fail'}'>
        <h3>Deployment Tests</h3>
        <p>Status: ${params.DEPLOYMENT_PASS ? 'PASS' : 'FAIL'}</p>
    </div>
    <div class='result ${params.VULNERABILITY_PASS ? 'pass' : 'fail'}'>
        <h3>Service Tests</h3>
        <p>Status: ${params.VULNERABILITY_PASS ? 'PASS' : 'FAIL'}</p>
    </div>
</body>
</html>
EOF
                            fi
                            
                            echo 'EKS report files generated:'
                            ls -la reports/
                        "
                """
            }
        }

        stage('ðŸ“¦ Archive Reports') {
            steps {
                sh """
                    echo "ðŸ“¦ Archiving reports..."
                    
                    # Ensure reports directory exists
                    mkdir -p "${WORKSPACE}/${REPORTS_DIR}"
                    
                    # Copy any generated reports
                    if [ -d "${WORKSPACE}/reports" ] && [ "\$(ls -A ${WORKSPACE}/reports 2>/dev/null)" ]; then
                        echo "Copying reports from ${WORKSPACE}/reports to ${WORKSPACE}/${REPORTS_DIR}/"
                        cp -r "${WORKSPACE}/reports/"* "${WORKSPACE}/${REPORTS_DIR}/" || echo "No reports to copy"
                    else
                        echo "No reports found in ${WORKSPACE}/reports, creating placeholder"
                        echo '<h1>EKS Tests Completed</h1><p>No detailed reports generated</p>' > "${WORKSPACE}/${REPORTS_DIR}/eks_summary.html"
                    fi
                    
                    echo "Final reports directory contents:"
                    ls -la "${WORKSPACE}/${REPORTS_DIR}/" || echo "Reports directory is empty"
                """
                
                // Archive the reports
                archiveArtifacts artifacts: '${REPORTS_DIR}/*.html, ${REPORTS_DIR}/*.json', allowEmptyArchive: true
            }
        }
    }

    post {
        always {
            echo "âœ¨ Chaos Agent defeatedâ€¦ or plotting his next move!"
        }
        success {
            echo "ðŸŽ‰ All EKS tests completed successfully!"
        }
        failure {
            echo "ðŸ’¥ Some EKS tests failed - Chaos Agent strikes again!"
        }
    }
}
