pipeline {
    agent any

    environment {
        PYTHONUNBUFFERED = '1'
        PIP_DISABLE_PIP_VERSION_CHECK = '1'
    }

    parameters {
        string(name: 'REPO_URL', defaultValue: 'https://github.com/vellankikoti/ci-cd-chaos-workshop.git', description: 'GitHub repository URL')
        string(name: 'REPO_BRANCH', defaultValue: 'phase-3-jenkins', description: 'Branch to clone')

        booleanParam(name: 'RUN_API_HEALTH_PASS', defaultValue: true, description: 'Run passing API health check test')
        booleanParam(name: 'RUN_API_HEALTH_FAIL', defaultValue: false, description: 'Run failing API health check test')

        booleanParam(name: 'RUN_POSTGRES_PASS', defaultValue: true, description: 'Run passing Postgres connectivity test')
        booleanParam(name: 'RUN_POSTGRES_FAIL', defaultValue: false, description: 'Run failing Postgres connectivity test')

        booleanParam(name: 'RUN_REDIS_PASS', defaultValue: true, description: 'Run passing Redis connectivity test')
        booleanParam(name: 'RUN_REDIS_FAIL', defaultValue: false, description: 'Run failing Redis connectivity test')

        booleanParam(name: 'RUN_SECRET_SCAN_PASS', defaultValue: true, description: 'Run passing secret scanning test')
        booleanParam(name: 'RUN_SECRET_SCAN_FAIL', defaultValue: false, description: 'Run failing secret scanning test')

        booleanParam(name: 'RUN_CONFIG_VALIDATION_PASS', defaultValue: true, description: 'Run passing config validation test')
        booleanParam(name: 'RUN_CONFIG_VALIDATION_FAIL', defaultValue: false, description: 'Run failing config validation test')
    }

    stages {
        stage('Pre-Cleanup') {
            steps {
                echo "‚ú® Cleaning workspace..."
                sh '''
                    rm -rf repo
                    rm -rf reports
                    mkdir -p reports
                '''
            }
        }

        stage('Checkout Repository') {
            steps {
                echo "üì• Cloning repository into workspace..."
                sh '''
                    git clone --single-branch --branch ${REPO_BRANCH} ${REPO_URL} repo
                '''
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "üõ†Ô∏è Building Docker image from correct path..."
                sh '''
                    docker build \
                        -f repo/Jenkins/jenkins_scenarios/scenario_03_html_reports/Dockerfile \
                        repo/Jenkins/jenkins_scenarios/scenario_03_html_reports \
                        -t ci-cd-chaos-html:latest
                '''
            }
        }

        stage('Run Selected Tests Inside Docker') {
            steps {
                script {
                    def relativeTests = []

                    if (params.RUN_API_HEALTH_PASS) {
                        relativeTests << "Jenkins/jenkins_scenarios/scenario_03_html_reports/tests/test_api_health_pass.py"
                    }
                    if (params.RUN_API_HEALTH_FAIL) {
                        relativeTests << "Jenkins/jenkins_scenarios/scenario_03_html_reports/tests/test_api_health_fail.py"
                    }
                    if (params.RUN_POSTGRES_PASS) {
                        relativeTests << "Jenkins/jenkins_scenarios/scenario_03_html_reports/tests/test_postgres_pass.py"
                    }
                    if (params.RUN_POSTGRES_FAIL) {
                        relativeTests << "Jenkins/jenkins_scenarios/scenario_03_html_reports/tests/test_postgres_fail.py"
                    }
                    if (params.RUN_REDIS_PASS) {
                        relativeTests << "Jenkins/jenkins_scenarios/scenario_03_html_reports/tests/test_redis_pass.py"
                    }
                    if (params.RUN_REDIS_FAIL) {
                        relativeTests << "Jenkins/jenkins_scenarios/scenario_03_html_reports/tests/test_redis_fail.py"
                    }
                    if (params.RUN_SECRET_SCAN_PASS) {
                        relativeTests << "Jenkins/jenkins_scenarios/scenario_03_html_reports/tests/test_secret_scan_pass.py"
                    }
                    if (params.RUN_SECRET_SCAN_FAIL) {
                        relativeTests << "Jenkins/jenkins_scenarios/scenario_03_html_reports/tests/test_secret_scan_fail.py"
                    }
                    if (params.RUN_CONFIG_VALIDATION_PASS) {
                        relativeTests << "Jenkins/jenkins_scenarios/scenario_03_html_reports/tests/test_config_validation_pass.py"
                    }
                    if (params.RUN_CONFIG_VALIDATION_FAIL) {
                        relativeTests << "Jenkins/jenkins_scenarios/scenario_03_html_reports/tests/test_config_validation_fail.py"
                    }

                    if (relativeTests.size() == 0) {
                        error "‚ö†Ô∏è No tests selected. Chaos Agent cannot be defeated without tests!"
                    }

                    docker.image('ci-cd-chaos-html:latest').inside('-u root') {
                        sh """
                            rm -rf /tests
                            git clone --single-branch --branch ${params.REPO_BRANCH} ${params.REPO_URL} /tests

                            echo '=== Files in repo ==='
                            ls -l /tests/Jenkins/jenkins_scenarios/scenario_03_html_reports/tests || true

                            cd /tests

                            pytest \
                                --html=/tests/reports/scenario_03_report.html \
                                --self-contained-html \
                                ${relativeTests.join(' ')}
                        """
                    }
                }
            }
        }

        stage('Copy Reports to Workspace') {
            steps {
                sh '''
                    docker cp $(docker ps -alq):/tests/reports ./reports || true
                '''
            }
        }

        stage('Parse Test Results') {
            steps {
                script {
                    def htmlPath = "reports/scenario_03_report.html"

                    if (fileExists(htmlPath)) {
                        echo "‚úÖ HTML report generated at: ${htmlPath}"
                    } else {
                        error "‚ö†Ô∏è HTML report not found. Something went wrong."
                    }
                }
            }
        }
    }

    post {
        always {
            echo "‚ú® Archiving Chaos Report Artifacts..."
            archiveArtifacts artifacts: 'reports/**/*.html', fingerprint: true
        }
    }
}
