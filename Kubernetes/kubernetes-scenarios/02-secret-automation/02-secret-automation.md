# 🔐 Scenario 02: Kubernetes Secret Management - Security Chaos to Hero

**"From Exposed Passwords to Enterprise-Grade Security"**

---

## 🎯 What You'll Learn

- Experience the horror of exposed secrets (safely!)
- Master automated secret generation and encryption
- Implement enterprise-grade security practices
- Deploy secure applications with Python automation
- Understand Kubernetes security best practices

**Time**: 20-30 minutes | **Difficulty**: ⭐⭐⭐☆☆

---

## 🚀 Quick Start

### Prerequisites

```bash
# 1. Kubernetes cluster running
kubectl cluster-info

# 2. Install Python dependencies
cd hero-solution
pip3 install -r requirements.txt
```

### Deploy Secure App (The Easy Way)

```bash
# ONE command for enterprise security
python3 deploy.py
```

**The script will output ready-to-copy commands!** Look for:

```
🔧 PORT-FORWARD COMMANDS (Copy & Paste):

   # Terminal 1: Start port-forward
   kubectl port-forward -n secure-todo svc/todo-app 31005:80

   # Then open: http://localhost:31005
```

**Copy and paste the commands from the output!** They include:
- ✅ Port-forward command for Todo App
- ✅ Security verification commands (decode secrets, verify non-root)
- ✅ Deployment verification commands
- ✅ Cleanup commands

**Result**: Secure todo app with auto-generated encrypted secrets, non-root container, read-only filesystem, and security best practices!

> **💡 Pro Tip:** The deployment script outputs everything you need. No need to memorize commands - just copy and paste!

---

## 🎮 The Security Chaos Experience

### Option A: Watch Security Fail (Recommended)

```bash
# See the security nightmare
python3 chaos/chaos-security-demo.py
```

**What happens:**
- Deploys with plain-text passwords in YAML
- Database exposed to internet via NodePort
- Extracts "stolen" credentials live
- Shows compliance failures (SOC2, PCI DSS, GDPR, HIPAA, ISO 27001)
- Simulates attack progression

**Then fix it:**
```bash
python3 hero-solution/deploy.py
```

### Option B: Compare YAML Files (Learn Security Best Practices)

```bash
# View insecure vs secure deployment side-by-side
diff -y chaos/insecure-deployment.yaml hero-solution/secure-deployment.yaml | less

# Or view them separately
cat chaos/insecure-deployment.yaml      # ❌ 10+ security disasters
cat hero-solution/secure-deployment.yaml  # ✅ Enterprise-grade security
```

**Security issues you'll discover:**
- ❌ Plain-text passwords in YAML (committed to Git!)
- ❌ Database exposed via NodePort (internet accessible)
- ❌ Hardcoded credentials in environment variables
- ❌ Secrets in ConfigMap (not encrypted at rest)
- ❌ Containers running as root (privilege escalation)
- ❌ No resource limits (DoS vulnerability)
- ❌ No network policies (unrestricted access)

**Security fixes you'll learn:**
- ✅ Secrets generated by automation (never in Git!)
- ✅ Database internal only (ClusterIP)
- ✅ Non-root containers with dropped capabilities
- ✅ Resource limits (DoS protection)
- ✅ Network policies (traffic restriction)
- ✅ Automated secret rotation (90-day lifecycle)
- ✅ Read-only root filesystem
- ✅ Health checks (detect compromises)

**Try deploying manually:**
```bash
# Deploy the insecure version (see the security nightmare)
kubectl apply -f chaos/insecure-deployment.yaml

# Check exposed database
kubectl get svc -n insecure-todo  # See NodePort 30306!

# View plain-text secrets
kubectl get secret mysql-password -n insecure-todo -o yaml | grep password | base64 -d

# Clean up
kubectl delete namespace insecure-todo

# Deploy the secure version
kubectl apply -f hero-solution/secure-deployment.yaml

# Or use automated security platform
python3 hero-solution/deploy.py
```

### Option C: Visual Security Breach Dashboard

```bash
# Launch hacker-themed dashboard
python3 chaos/security-breach-dashboard.py

# Open: http://localhost:6000 (or auto-selected port)
```

**Experience:**
- 💀 Matrix-style hacker UI with glitch effects
- 🚨 Live "attack" log showing breach steps
- 🔓 Exposed credentials displayed
- 📉 Security score: 0% (complete failure)
- 🎯 8+ critical vulnerabilities with CVSS scores

---

## 📊 What Gets Deployed

### Secure Todo Application Stack

```
┌─────────────────────────────────────────┐
│      Secure-Todo Namespace              │
├─────────────────────────────────────────┤
│  Secure Todo App (2 replicas)           │  ← Web interface
│  Secure MySQL (1 replica)               │  ← Encrypted storage
├─────────────────────────────────────────┤
│  Secrets (Encrypted):                   │
│  - mysql-credentials                    │  ← Auto-generated
│  - app-credentials                      │  ← Auto-generated
├─────────────────────────────────────────┤
│  Security Features:                     │
│  - Non-root containers                  │
│  - Dropped capabilities                 │
│  - Resource limits                      │
│  - Network isolation                    │
│  - Audit logging                        │
└─────────────────────────────────────────┘
```

### Security Features Included

✅ **Cryptographic Secret Generation**: 32-character secure passwords
✅ **Kubernetes Secrets Encryption**: Base64 + etcd encryption at rest
✅ **Automated Rotation**: Configurable 7-30 day policies
✅ **Security Contexts**: Non-root users, dropped capabilities
✅ **Network Isolation**: Database internal-only (ClusterIP)
✅ **Resource Limits**: DoS protection
✅ **Audit Trails**: Complete metadata tracking
✅ **Compliance Ready**: SOC2, PCI DSS, GDPR, HIPAA, ISO 27001

---

## 🌐 Accessing Your Secure App

### After deployment:

```
🎉 DEPLOYMENT COMPLETE!

📊 ACCESS INFORMATION:
  📱 Todo App (Web Interface):
     - Port Forward: kubectl port-forward svc/secure-todo-service 3000:80 -n secure-todo
     - Then access: http://localhost:3000
```

### Universal Access (Always Works)

```bash
# Terminal 1
kubectl port-forward svc/secure-todo-service -n secure-todo 3000:80

# Open browser
http://localhost:3000
```

---

## 🔐 How Security Works

### The Hero Solution

**File**: `hero-solution/deploy.py` + `security_platform.py`

```python
class SecurityPlatform:
    def create_secure_secret(self, name, data):
        # Generate cryptographically secure passwords
        secure_password = secrets.token_urlsafe(32)

        # Encrypt and store in Kubernetes Secret
        secret = client.V1Secret(
            metadata=client.V1ObjectMeta(
                annotations={
                    'rotation-policy': '30-days',
                    'security-level': 'high'
                }
            ),
            data={
                key: base64.b64encode(value.encode()).decode()
            }
        )

        # Apply security contexts
        security_context = client.V1SecurityContext(
            run_as_non_root=True,
            run_as_user=1000,
            allow_privilege_escalation=False,
            capabilities=client.V1Capabilities(drop=["ALL"])
        )
```

**Key Security Layers:**
1. **Secret Generation**: Python `secrets` module (cryptographically secure)
2. **Encryption at Rest**: Kubernetes Secrets with etcd encryption
3. **Network Isolation**: MySQL ClusterIP only (no external access)
4. **Container Security**: Non-root, dropped capabilities, read-only filesystem
5. **Resource Protection**: CPU/memory limits prevent DoS
6. **Audit Logging**: All secret access tracked

---

## 💀 The Chaos Demo Explained

### What's Wrong with Insecure Deployment?

**File**: `chaos/insecure-deployment.yaml`

```yaml
# ❌ DISASTER 1: Plain-text passwords
apiVersion: v1
kind: Secret
metadata:
  name: mysql-password
stringData:
  mysql-password: "super_secret_password_123"  # 🚨 EXPOSED!
  # This gets committed to Git!!!

# ❌ DISASTER 2: Database exposed to internet
apiVersion: v1
kind: Service
metadata:
  name: insecure-mysql-service
spec:
  type: NodePort  # 🚨 Anyone can connect!
  ports:
  - port: 3306
    nodePort: 30306  # 🚨 mysql://localhost:30306

# ❌ DISASTER 3: Secrets in ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-secrets  # 🚨 ConfigMaps NOT encrypted!
data:
  admin-password: "admin123"  # 🚨 Plain text!
  stripe-api-key: "sk_live_EXPOSED"  # 🚨 Payment breach!

# ❌ DISASTER 4: Running as root
spec:
  containers:
  - name: app
    # No securityContext = runs as root (UID 0)
    # ❌ Privilege escalation possible

# ❌ DISASTER 5: No resource limits
# ❌ Container can consume all cluster resources (DoS attack)
```

**Result**: Complete security breach, compliance failures, data theft!

---

## 🎨 Security Breach Dashboard

**File**: `chaos/security-breach-dashboard.py`

Launch with: `python3 chaos/security-breach-dashboard.py`

### What You Experience:

**🚨 Hacker-Themed UI**:
- Green-on-black Matrix aesthetic
- Pulsing "SECURITY BREACH IN PROGRESS" banner
- Glitch animations for dramatic effect

**💀 Chaos Agent's Trophy Room**:
- Live secret extraction from Kubernetes
- Progressive attack log (15+ steps)
- Real credentials displayed as "stolen"

**📊 Vulnerability Assessment**:
- 8 critical vulnerabilities listed
- CVSS scores (9.8, 9.1, 9.0, etc.)
- Compliance failures for all standards

**🎭 Attack Simulation**:
```
🔍 Scanning for exposed services...
🎯 Found MySQL on NodePort 30306 - JACKPOT!
💾 Extracting database credentials...
🔓 Successfully accessed MySQL as root
📥 Downloading user database...
💰 Your cluster is now mining Bitcoin for Chaos Agent
💀 GAME OVER - Total compromise achieved
```

**Port Handling**: Auto-finds free port if 6000 is busy

---

## 🛡️ Security Best Practices Demonstrated

### 1. Secret Generation

```python
# ❌ WRONG
password = "hardcoded123"

# ✅ CORRECT
import secrets
password = secrets.token_urlsafe(32)  # Cryptographically secure
```

### 2. Secret Storage

```yaml
# ❌ WRONG - ConfigMap
kind: ConfigMap
data:
  password: "exposed"  # NOT encrypted!

# ✅ CORRECT - Secret
kind: Secret
data:
  password: <base64-encoded>  # Encrypted at rest
```

### 3. Network Isolation

```yaml
# ❌ WRONG - Internet exposed
spec:
  type: NodePort  # Database accessible from outside!

# ✅ CORRECT - Internal only
spec:
  type: ClusterIP  # Internal cluster access only
```

### 4. Container Security

```yaml
# ❌ WRONG - Root user
spec:
  containers:
  - name: app
    # No securityContext = runs as root

# ✅ CORRECT - Non-root, hardened
spec:
  containers:
  - name: app
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
```

### 5. Resource Protection

```yaml
# ❌ WRONG - No limits
# Container can consume unlimited resources

# ✅ CORRECT - Protected
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "256Mi"
    cpu: "200m"
```

---

## 🚨 Troubleshooting

### "Can't access todo app"

```bash
# Always works - port forward
kubectl port-forward svc/secure-todo-service -n secure-todo 3000:80

# Keep terminal open, access:
http://localhost:3000
```

### "MySQL connection failed"

```bash
# Check MySQL logs
kubectl logs -n secure-todo -l app=secure-mysql

# Check secret exists
kubectl get secrets -n secure-todo

# Verify secret in deployment
kubectl describe deployment secure-todo-app -n secure-todo | grep -A 10 secretKeyRef
```

### "Secrets not found"

The deployment automatically creates secrets. If missing, redeploy:

```bash
python3 hero-solution/deploy.py
```

---

## 🧹 Cleanup

```bash
# Remove secure deployment
kubectl delete namespace secure-todo

# Remove insecure chaos (if deployed)
kubectl delete namespace insecure-todo

# Verify
kubectl get namespaces | grep todo
# Should return nothing
```

---

## 📚 Files Structure

```
02-secret-automation/
├── scenario_02_security.md        # This file
├── chaos/
│   ├── chaos-security-demo.py     # Security nightmare demo
│   ├── security-breach-dashboard.py # Hacker UI visualization
│   ├── insecure-deployment.yaml   # All the anti-patterns
│   └── requirements.txt           # Python dependencies
└── hero-solution/
    ├── deploy.py                  # Secure deployment
    ├── security_platform.py       # Security automation
    ├── rotate-secrets.py          # Auto-rotation (optional)
    ├── security-monitor.py        # Monitoring (optional)
    └── requirements.txt           # Python dependencies
```

---

## 🎓 Key Takeaways

### What You Learned

1. **Never Hardcode Secrets**: Always use Kubernetes Secrets
2. **Generate Don't Write**: Use crypto-secure generation
3. **Encrypt at Rest**: Kubernetes Secrets + etcd encryption
4. **Network Isolation**: Databases should be ClusterIP only
5. **Security Contexts**: Always run as non-root
6. **Resource Limits**: Prevent DoS attacks
7. **Audit Everything**: Track all secret access
8. **Automate Rotation**: Secrets should expire and rotate

### Security Frameworks

**Compliance Demonstrated:**
- ✅ **SOC2**: Access controls + audit logging
- ✅ **PCI DSS**: Payment data protection
- ✅ **GDPR**: Data protection by design
- ✅ **HIPAA**: PHI protection
- ✅ **ISO 27001**: Security controls

### Real-World Impact

**Without Security Automation:**
- 💀 Average cost of data breach: $4.45M (2023)
- 💀 Average time to detect breach: 204 days
- 💀 Exposed credentials #1 attack vector
- 💀 83% of breaches involve human error

**With Security Automation:**
- ✅ Eliminate hardcoded secrets
- ✅ Reduce breach detection time
- ✅ Automatic compliance
- ✅ Zero human error in secret management

---

## 🚀 Next Steps

### Immediate Actions

1. **Run the chaos demo** to see security failures
2. **Launch the breach dashboard** for visual impact
3. **Deploy the hero solution** and feel secure
4. **Test the todo app** - it's encrypted!

### Advanced Features (Optional)

```bash
# Test secret rotation
python3 hero-solution/rotate-secrets.py

# Monitor security status
python3 hero-solution/security-monitor.py

# Check compliance
python3 hero-solution/compliance_reporter.py
```

### Continue Learning

**Scenario 03**: Auto-scaling & Performance →
**Scenario 04**: Advanced Deployment Strategies →
**Scenario 05**: GitOps & Complete Automation →

---

## 💡 Pro Tips

1. **Secrets in Git**: NEVER commit secrets to Git. Use Kubernetes Secrets or external secret managers (AWS Secrets Manager, HashiCorp Vault)
2. **Rotation Policies**: Rotate secrets every 30-90 days minimum
3. **Least Privilege**: Containers should drop ALL capabilities by default
4. **Network Policies**: Add Kubernetes NetworkPolicies for additional isolation
5. **Image Scanning**: Always scan images for vulnerabilities (Trivy, Clair)
6. **Audit Logs**: Enable Kubernetes audit logging for compliance

---

## 🔗 Additional Resources

- [Kubernetes Secrets Best Practices](https://kubernetes.io/docs/concepts/security/secrets-good-practices/)
- [CIS Kubernetes Benchmark](https://www.cisecurity.org/benchmark/kubernetes)
- [OWASP Kubernetes Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Kubernetes_Security_Cheat_Sheet.html)
- [NSA Kubernetes Hardening Guide](https://media.defense.gov/2021/Aug/03/2002820425/-1/-1/0/CTR_Kubernetes_Hardening_Guidance_1.1_20220315.PDF)

---

**Remember**: Automate security, don't hope for it! 🔐🦸

---

*Scenario 02 - Kubernetes Security Automation*
*Part of CI/CD Chaos Workshop*
